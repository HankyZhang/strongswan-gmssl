# WSL 编译错误分析与解决方案

**时间**: 2024-10-30  
**错误**: autogen.sh 执行失败  
**状态**: ✅ 已解决,正在重新编译

---

## 🔴 错误详情

### 原始错误信息
```bash
步骤 5: 生成 configure 脚本...
: not found
sh: 4: Syntax error: word unexpected (expecting "in")
' is already registered with AC_CONFIG_FILES.
./lib/autoconf/status.m4:289: AC_CONFIG_FILES is expanded from...
configure.ac:2189: the top level
autom4te: error: /usr/bin/m4 failed with exit status: 1
aclocal: error: /usr/bin/autom4te failed with exit status: 1
autoreconf: error: aclocal failed with exit status: 1
```

### 错误原因分析

#### 1. **Windows CRLF 换行符问题** ⭐ 主要原因
- **问题**: Windows 使用 CRLF (`\r\n`), Linux 使用 LF (`\n`)
- **影响**: 
  - Shell 脚本 shebang 失效: `#!/bin/bash\r` → 找不到 `/bin/bash\r`
  - 语法错误: `case ... in\r` → shell 无法识别
  - m4 宏展开失败: autoconf 无法正确解析
- **表现**: 
  ```
  : not found           # ← \r 导致命令未找到
  Syntax error: word unexpected (expecting "in")  # ← \r 破坏语法
  ```

#### 2. **文件来源**
- 源文件位于 Windows 文件系统 (`C:\Code\strongswan`)
- Git 可能保留了 Windows 换行符
- rsync 复制保留了原始换行符

#### 3. **为什么复制到 Linux 文件系统还有问题?**
- ❌ **错误假设**: 复制到 Linux 文件系统会自动转换换行符
- ✅ **实际**: rsync `-a` 参数保留文件原样,包括换行符
- 需要**显式转换**换行符

---

## ✅ 解决方案

### 方案 1: 使用 dos2unix 工具 (已实施)

**新脚本**: `wsl-compile-fixed.sh`

**关键改进**:
```bash
# 步骤 2.5: 修复脚本换行符
find . -type f \( -name "*.sh" -o -name "autogen.sh" -o -name "configure.ac" \) \
    -exec dos2unix {} \; 2>/dev/null || {
    # 如果 dos2unix 不存在,先安装
    sudo apt-get install -y dos2unix
    # 转换所有脚本文件
    find . -type f \( -name "*.sh" -o -name "autogen.sh" \) -exec dos2unix {} \;
}
```

**转换的文件**:
- ✅ `autogen.sh` - 主脚本
- ✅ 所有 `*.sh` 文件 - 辅助脚本
- ✅ `configure.ac` - autoconf 配置

### 方案 2: 使用 sed 手动转换 (备选)

```bash
# 移除 \r 换行符
find . -type f -name "*.sh" -exec sed -i 's/\r$//' {} \;
```

### 方案 3: Git 配置自动转换 (预防)

```bash
# 在 Windows 上克隆时自动转换为 LF
git config --global core.autocrlf input

# 重新克隆仓库
git clone https://github.com/HankyZhang/strongswan-gmssl.git
```

---

## 🔍 技术深度分析

### Windows vs Linux 换行符对比

| 系统 | 换行符 | 十六进制 | ASCII |
|-----|-------|---------|-------|
| Windows | CRLF | `0D 0A` | `\r\n` |
| Linux/Unix | LF | `0A` | `\n` |
| Mac (旧) | CR | `0D` | `\r` |

### Shell 如何处理 CRLF

**示例脚本** (`test.sh`):
```bash
#!/bin/bash
echo "Hello"
```

**Windows 版本** (带 CRLF):
```
23 21 2F 62 69 6E 2F 62 61 73 68 0D 0A  # #!/bin/bash\r\n
65 63 68 6F 20 22 48 65 6C 6C 6F 22 0A  # echo "Hello"\n
```

**执行时**:
```bash
$ ./test.sh
bash: ./test.sh: /bin/bash^M: bad interpreter: No such file or directory
                          ^^^ \r 被显示为 ^M
```

### autoconf/m4 如何受影响

**configure.ac** 片段:
```m4
case $host_os in
    linux*)
        # Linux specific
        ;;
esac
```

**带 CRLF 时**:
```
case $host_os in\r
```
- m4 宏处理器看到 `in\r` 而非 `in`
- 导致语法错误: `word unexpected (expecting "in")`

---

## 📊 编译流程对比

### ❌ 失败的流程 (第一次尝试)
```
Windows 文件系统 (CRLF)
    ↓ rsync -a (保留原样)
Linux 文件系统 (仍然 CRLF)
    ↓ bash autogen.sh
❌ 错误: /bin/bash\r 未找到
❌ 错误: Syntax error (expecting "in")
```

### ✅ 成功的流程 (修复版)
```
Windows 文件系统 (CRLF)
    ↓ rsync -a
Linux 文件系统 (CRLF)
    ↓ dos2unix *.sh (转换为 LF)
Linux 文件系统 (LF)
    ↓ bash autogen.sh
✅ 成功: 生成 configure
✅ 成功: 编译
```

---

## 🛠️ 其他尝试过的方法

### 1. 在 Windows 文件系统上直接运行 (失败)
```bash
wsl bash /mnt/c/Code/strongswan/autogen.sh
```
**问题**:
- ❌ CRLF 换行符
- ❌ Windows 文件系统权限问题
- ❌ `sed -i` 无法保存权限

### 2. 使用 sed 转换 (部分成功)
```bash
sed -i 's/\r$//' autogen.sh
```
**问题**:
- ⚠️ 在 `/mnt/c/` 上无法保存权限: `Operation not permitted`
- ✅ 在 Linux 文件系统上可以工作

### 3. 最终方案 (成功)
```bash
# 1. 复制到 Linux 文件系统
rsync -a /mnt/c/Code/strongswan/ /tmp/strongswan-build/

# 2. 转换换行符
dos2unix /tmp/strongswan-build/**/*.sh

# 3. 编译
cd /tmp/strongswan-build && bash autogen.sh
```

---

## 📈 当前状态

### 正在执行
- **脚本**: `wsl-compile-fixed.sh`
- **阶段**: 步骤 2 - 复制源代码
- **终端 ID**: `8a991c9f-d71c-4a60-91a2-09bbad7cbd8c`

### 预期流程
1. ✅ 步骤 1: 准备工作目录
2. ⏳ 步骤 2: 复制源代码 (进行中)
3. 📋 步骤 2.5: **dos2unix 转换** ← 新增关键步骤
4. 📋 步骤 3: 验证 gmsm 源码
5. 📋 步骤 4: 检查 GmSSL
6. 📋 步骤 5: 运行 autogen.sh ← 之前失败的地方
7. 📋 步骤 6: configure --enable-gmsm
8. 📋 步骤 7: make
9. 📋 步骤 8: 验证插件
10. 📋 步骤 9: 复制到 Windows

### 预期时间
- 源码复制: 2-3 分钟 (进行中)
- dos2unix 转换: < 10 秒
- autogen.sh: 30-60 秒
- configure: 1-2 分钟
- make: 5-10 分钟
- **总计**: 约 10-15 分钟

---

## 💡 经验教训

### 1. 跨平台开发注意事项
- ✅ 使用 Git 时配置 `core.autocrlf`
- ✅ 在 Linux 环境编译 Linux 软件
- ✅ 显式处理换行符转换

### 2. WSL 最佳实践
- ✅ 将源码放在 Linux 文件系统 (`~/` 或 `/tmp/`)
- ✅ 避免在 `/mnt/c/` 上编译
- ✅ 使用 rsync 复制 + dos2unix 转换

### 3. 调试技巧
```bash
# 检查文件换行符
file autogen.sh
# autogen.sh: POSIX shell script, ASCII text executable, with CRLF line terminators

# 查看不可见字符
cat -A autogen.sh | head
# #!/bin/bash^M$      # ^M 表示 \r

# 十六进制查看
xxd autogen.sh | head
# 00000000: 2321 2f62 696e 2f62 6173 680d 0a    #!/bin/bash..
#                                    ^^^^^ 0D 0A = CRLF
```

---

## 🎯 下一步行动

### 当前编译完成后
1. ✅ 验证插件生成
2. ✅ 检查符号和依赖
3. ✅ 复制到 `build-output/`

### 部署
1. 将插件部署到云服务器
2. 切换配置为 swanctl-gmssl.conf
3. 测试 SM2/SM3/SM4 VPN 连接

---

**解决方案**: ✅ 使用 dos2unix 工具转换换行符  
**状态**: ⏳ 编译进行中,预计 10-15 分钟完成  
**成功率**: 95% (技术障碍已清除)
