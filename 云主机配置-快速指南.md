# 🚀 VPN 云主机配置 - 操作指南

## 📋 配置信息

| 项目 | 值 |
|------|-----|
| **云主机IP** | 101.126.148.5 |
| **云主机用户** | root |
| **云主机密码** | sitech#18%U |
| **云端网段** | 10.2.0.0/24 |
| **本地公网IP** | 4.149.0.195 |
| **本地网段** | 10.1.0.0/24 |
| **PSK密钥** | MyStrongPSK2024!@#SecureVPN |

---

## ⚡ 快速开始（5分钟完成）

### 步骤 1: SSH 连接云主机

在 PowerShell 中执行：

```powershell
ssh root@101.126.148.5
```

输入密码: `sitech#18%U`

### 步骤 2: 一键配置（复制整段代码）

连接成功后，将下面的完整脚本复制粘贴到 SSH 终端：

```bash
#!/bin/bash
set -e
echo '=== strongSwan VPN 云主机自动配置 ==='

# 1. 安装依赖
export DEBIAN_FRONTEND=noninteractive
echo '[1/5] 安装依赖包...'
apt-get update -qq
apt-get install -y -qq build-essential libpam0g-dev libssl-dev pkg-config libgmp3-dev gettext wget libsystemd-dev libcurl4-openssl-dev libcap-ng-dev iptables iproute2 net-tools vim

# 2. 下载编译 strongSwan
echo '[2/5] 下载编译 strongSwan 5.9.6...'
cd /tmp
wget -q https://download.strongswan.org/strongswan-5.9.6.tar.gz
tar -zxf strongswan-5.9.6.tar.gz
cd strongswan-5.9.6
./configure --prefix=/usr/local/strongswan --sysconfdir=/etc --enable-eap-identity --enable-eap-md5 --enable-eap-mschapv2 --enable-eap-tls --enable-dhcp --enable-openssl --enable-tools --enable-swanctl --enable-vici --disable-gmp --enable-kernel-netlink > /dev/null
make -j $(nproc) > /dev/null && make install > /dev/null
echo '✅ strongSwan 安装完成'

# 3. 配置环境
echo '[3/5] 配置环境...'
echo 'export PATH="/usr/local/strongswan/bin:/usr/local/strongswan/sbin:$PATH"' >> /etc/profile.d/strongswan.sh
source /etc/profile.d/strongswan.sh
mkdir -p /etc/swanctl/{x509,x509ca,private,rsa,conf.d}
chmod 700 /etc/swanctl/private

# 4. 系统参数
echo '[4/5] 配置系统参数...'
cat >> /etc/sysctl.conf <<'SYSEOF'
net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
SYSEOF
sysctl -p > /dev/null
iptables -t nat -C POSTROUTING -s 10.2.0.0/24 -j MASQUERADE 2>/dev/null || iptables -t nat -A POSTROUTING -s 10.2.0.0/24 -j MASQUERADE

# 5. VPN 配置
echo '[5/5] 创建 VPN 配置...'
cat > /etc/swanctl/swanctl.conf <<'VPNEOF'
connections {
    cloud-to-site {
        version = 2
        local_addrs = 101.126.148.5
        remote_addrs = 4.149.0.195
        
        local {
            auth = psk
            id = cloud-server
        }
        remote {
            auth = psk
            id = site-vpn
        }
        
        children {
            cloud-net {
                local_ts = 10.2.0.0/24
                remote_ts = 10.1.0.0/24
                esp_proposals = aes256-sha256-modp2048
                start_action = start
                dpd_action = restart
            }
        }
        proposals = aes256-sha256-modp2048
    }
}

secrets {
    ike-cloud {
        id-cloud = cloud-server
        id-site = site-vpn
        secret = "MyStrongPSK2024!@#SecureVPN"
    }
}
VPNEOF

# 6. 启动
echo '启动 strongSwan...'
/usr/local/strongswan/sbin/charon &
sleep 3
/usr/local/strongswan/sbin/swanctl --load-all

echo ''
echo '✅ 配置完成！'
/usr/local/strongswan/sbin/swanctl --list-conns
/usr/local/strongswan/sbin/swanctl --list-sas

cd / && rm -rf /tmp/strongswan-*
```

配置过程大约需要 **3-5 分钟**，请耐心等待。

### 步骤 3: 验证云端配置

配置完成后，检查输出应该看到：

```
cloud-to-site: IKEv2, no reauthentication, rekeying every 14400s
  local:  101.126.148.5
  remote: 4.149.0.195
  cloud-net: TUNNEL, rekeying every 3600s
    local:  10.2.0.0/24
    remote: 10.1.0.0/24
```

---

## 🏠 本地端操作

云主机配置完成后，在本地 Windows 执行：

### 1. 检查并重启本地容器

```powershell
cd C:\Code\strongswan

# 查看容器状态
docker-compose ps

# 重启容器（加载更新的配置）
docker-compose restart vpn-server

# 查看容器日志
docker-compose logs vpn-server
```

### 2. 发起 VPN 连接

```powershell
# 方式一：直接发起连接
docker-compose exec vpn-server swanctl --initiate --child cloud-net

# 方式二：进入容器操作
docker-compose exec vpn-server bash
# 在容器内执行：
swanctl --initiate --child cloud-net
swanctl --list-sas
```

### 3. 查看连接状态

```powershell
docker-compose exec vpn-server swanctl --list-sas
```

成功输出示例：
```
cloud-net: #1, ESTABLISHED, IKEv2
  local  'site-vpn' @ 10.1.0.1[4500]
  remote 'cloud-server' @ 101.126.148.5[4500]
  established 5s ago
  cloud-net: #1, reqid 1, INSTALLED, TUNNEL
    installed 5s ago
    ESP: AES_CBC-256/HMAC_SHA2_256_128
    10.1.0.0/24 === 10.2.0.0/24
```

### 4. 测试连通性

```powershell
# 从本地 ping 云端虚拟IP
docker-compose exec vpn-server ping -c 4 10.2.0.1
```

在云主机上测试：
```bash
ping -c 4 10.1.0.1
```

---

## 🔍 故障排查

### 云主机端

```bash
# 查看 strongSwan 进程
ps aux | grep charon

# 查看实时日志
tail -f /var/log/syslog | grep charon

# 重新加载配置
/usr/local/strongswan/sbin/swanctl --load-all

# 查看连接状态
/usr/local/strongswan/sbin/swanctl --list-conns
/usr/local/strongswan/sbin/swanctl --list-sas

# 查看路由
ip route

# 查看防火墙规则
iptables -t nat -L -n -v
```

### 本地端

```powershell
# 查看容器日志
docker-compose logs -f vpn-server

# 进入容器检查
docker-compose exec vpn-server bash

# 在容器内：
swanctl --list-conns
swanctl --list-sas
ip route
```

### 常见问题

1. **连接超时**
   - 检查云服务器安全组是否开放 UDP 500 和 4500 端口
   - 检查本地防火墙设置

2. **PSK 认证失败**
   - 确认双方配置文件中的 PSK 密钥一致
   - 检查 ID 配置是否匹配

3. **路由问题**
   - 确认 IP 转发已启用：`sysctl net.ipv4.ip_forward`
   - 检查 iptables NAT 规则

---

## 📝 重要提醒

### ✅ 云服务器安全组配置

确保开放以下端口：
- **UDP 500** - IKE 协商
- **UDP 4500** - NAT-T (NAT 穿透)
- **ESP协议** - 如果防火墙支持

### ✅ 配置文件一致性检查

| 项目 | 本地配置 | 云端配置 |
|------|---------|---------|
| local id | site-vpn | cloud-server |
| remote id | cloud-server | site-vpn |
| PSK | MyStrongPSK2024!@#SecureVPN | MyStrongPSK2024!@#SecureVPN |
| local_ts | 10.1.0.0/24 | 10.2.0.0/24 |
| remote_ts | 10.2.0.0/24 | 10.1.0.0/24 |
| remote_addrs | 101.126.148.5 | 4.149.0.195 |

---

## 🎯 验证清单

- [ ] 云主机 strongSwan 已安装并运行
- [ ] 云主机防火墙端口已开放 (UDP 500/4500)
- [ ] 云主机 VPN 配置文件正确
- [ ] 本地容器正常运行
- [ ] 本地配置文件已更新
- [ ] 双方 PSK 密钥一致
- [ ] 能够发起连接
- [ ] 连接状态显示 ESTABLISHED
- [ ] 双向 ping 测试成功

---

## 🎉 成功示例

### 连接建立成功：

**云端输出：**
```
cloud-to-site: IKEv2, ESTABLISHED
  local:  'cloud-server' @ 101.126.148.5
  remote: 'site-vpn' @ 4.149.0.195
  cloud-net: TUNNEL, INSTALLED
    ESP: AES_CBC-256/HMAC_SHA2_256_128
    10.2.0.0/24 === 10.1.0.0/24
```

**本地输出：**
```
site-to-cloud: IKEv2, ESTABLISHED
  local:  'site-vpn' @ 10.1.0.1
  remote: 'cloud-server' @ 101.126.148.5
  cloud-net: TUNNEL, INSTALLED
    ESP: AES_CBC-256/HMAC_SHA2_256_128
    10.1.0.0/24 === 10.2.0.0/24
```

**Ping 测试成功：**
```bash
# 本地 -> 云端
ping 10.2.0.1
PING 10.2.0.1: 64 bytes from 10.2.0.1: icmp_seq=1 ttl=64 time=20ms

# 云端 -> 本地
ping 10.1.0.1
PING 10.1.0.1: 64 bytes from 10.1.0.1: icmp_seq=1 ttl=64 time=20ms
```

---

## 📞 技术支持

如遇问题，请提供：
1. 云端日志：`/var/log/syslog | grep charon`
2. 本地日志：`docker-compose logs vpn-server`
3. 连接状态：`swanctl --list-sas` (双方)
4. 网络配置：`ip addr`, `ip route`

---

**配置文件位置：**
- 本地：`C:\Code\strongswan\config\swanctl\swanctl.conf`
- 云端：`/etc/swanctl/swanctl.conf`
- 脚本：`C:\Code\strongswan\cloud-vpn-setup-final.sh`
