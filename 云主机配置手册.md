# 云主机 VPN 配置 - 手动操作指南

## 📋 配置信息
- **云主机IP**: 101.126.148.5
- **用户名**: root
- **密码**: sitech#18%U
- **云端网段**: 10.2.0.0/24
- **本地网段**: 10.1.0.0/24

---

## 🚀 快速配置（3分钟完成）

### 步骤 1：SSH 连接到云主机

在 PowerShell 或 CMD 中执行：

```powershell
ssh root@101.126.148.5
# 输入密码: sitech#18%U
```

### 步骤 2：一键配置命令

连接成功后，**复制粘贴**以下完整命令块（一次性粘贴所有内容）：

```bash
# ===== 开始配置 =====
export DEBIAN_FRONTEND=noninteractive

# 1. 安装依赖
echo "▶ 安装依赖包..."
apt-get update -qq && apt-get install -y -qq \
    build-essential libpam0g-dev libssl-dev pkg-config \
    libgmp3-dev gettext wget libsystemd-dev \
    libcurl4-openssl-dev libcap-ng-dev \
    iptables iproute2 net-tools vim

# 2. 下载编译 strongSwan
echo "▶ 下载编译 strongSwan 5.9.6..."
cd /tmp
wget -q https://download.strongswan.org/strongswan-5.9.6.tar.gz
tar -zxf strongswan-5.9.6.tar.gz
cd strongswan-5.9.6
./configure --prefix=/usr/local/strongswan --sysconfdir=/etc \
    --enable-eap-identity --enable-eap-md5 --enable-eap-mschapv2 \
    --enable-eap-tls --enable-dhcp --enable-openssl \
    --enable-tools --enable-swanctl --enable-vici --disable-gmp \
    --enable-kernel-netlink > /dev/null
make -j $(nproc) > /dev/null
make install > /dev/null
echo "✅ strongSwan 安装完成"

# 3. 配置环境
echo "▶ 配置环境..."
echo 'export PATH="/usr/local/strongswan/bin:/usr/local/strongswan/sbin:$PATH"' >> /etc/profile.d/strongswan.sh
source /etc/profile.d/strongswan.sh
mkdir -p /etc/swanctl/{x509,x509ca,private,rsa,conf.d}
chmod 700 /etc/swanctl/private

# 4. 系统参数
echo "▶ 配置系统参数..."
cat >> /etc/sysctl.conf <<'SYSCTL_EOF'
net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
SYSCTL_EOF
sysctl -p > /dev/null

# 5. 防火墙
iptables -t nat -C POSTROUTING -s 10.2.0.0/24 -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -s 10.2.0.0/24 -j MASQUERADE

echo "✅ 基础配置完成"
# ===== 基础配置结束 =====
```

### 步骤 3：创建 VPN 配置

**重要**: 先获取你的本地公网IP，然后替换下面命令中的 `YOUR_LOCAL_PUBLIC_IP`

检测本地公网IP（在本地 Windows 执行）：
```powershell
(Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
```

然后在云主机上执行（**替换YOUR_LOCAL_PUBLIC_IP**）：

```bash
# 创建 VPN 配置文件
cat > /etc/swanctl/swanctl.conf <<'VPN_EOF'
connections {
    cloud-to-site {
        version = 2
        local_addrs = 101.126.148.5
        remote_addrs = YOUR_LOCAL_PUBLIC_IP
        
        local {
            auth = psk
            id = cloud-server
        }
        remote {
            auth = psk
            id = site-vpn
        }
        
        children {
            cloud-net {
                local_ts = 10.2.0.0/24
                remote_ts = 10.1.0.0/24
                esp_proposals = aes256-sha256-modp2048
                start_action = start
                dpd_action = restart
            }
        }
        proposals = aes256-sha256-modp2048
    }
}

secrets {
    ike-cloud {
        id-cloud = cloud-server
        id-site = site-vpn
        secret = "MyStrongPSK2024!@#SecureVPN"
    }
}
VPN_EOF

echo "✅ VPN 配置文件已创建"
```

### 步骤 4：启动 strongSwan

```bash
# 启动 charon 守护进程
/usr/local/strongswan/sbin/charon &

# 等待启动
sleep 3

# 加载配置
/usr/local/strongswan/sbin/swanctl --load-all

# 查看配置
echo ""
echo "=== VPN 连接配置 ==="
/usr/local/strongswan/sbin/swanctl --list-conns

echo ""
echo "=== 当前连接状态 ==="
/usr/local/strongswan/sbin/swanctl --list-sas
```

### 步骤 5：验证配置

检查 strongSwan 是否运行：
```bash
ps aux | grep charon
```

查看日志：
```bash
tail -20 /var/log/syslog | grep charon
```

---

## 🏠 本地端操作

配置完云主机后，返回本地 Windows：

### 1. 检查本地 Docker 容器

```powershell
cd C:\Code\strongswan
docker-compose ps
```

### 2. 发起连接

```powershell
# 方式一：使用 docker-compose
docker-compose exec vpn-server swanctl --initiate --child cloud-net

# 方式二：进入容器手动操作
docker-compose exec vpn-server bash
# 在容器内执行：
swanctl --initiate --child cloud-net
```

### 3. 查看连接状态

```powershell
docker-compose exec vpn-server swanctl --list-sas
```

### 4. 测试连通性

```powershell
# 进入本地容器
docker-compose exec vpn-server bash

# Ping 云端虚拟IP
ping 10.2.0.1
```

从云主机测试：
```bash
ping 10.1.0.1
```

---

## 🔍 故障排查

### 云主机端

查看日志：
```bash
tail -f /var/log/syslog | grep charon
```

检查进程：
```bash
ps aux | grep charon
```

重新加载配置：
```bash
/usr/local/strongswan/sbin/swanctl --load-all
```

### 本地端

查看日志：
```powershell
docker-compose logs vpn-server
```

重启容器：
```powershell
docker-compose restart vpn-server
```

---

## 📝 重要提醒

1. ✅ 确保云服务器安全组开放端口：
   - UDP 500 (IKE)
   - UDP 4500 (NAT-T)

2. ✅ 确保本地 Docker 配置正确：
   - 检查 `config/swanctl/swanctl.conf`
   - 确认 PSK 密钥一致：`MyStrongPSK2024!@#SecureVPN`

3. ✅ 确保 remote_addrs 配置正确：
   - 云端配置：本地公网IP
   - 本地配置：101.126.148.5

4. ✅ 清理临时文件（云端）：
```bash
cd /
rm -rf /tmp/strongswan-*
```

---

## 🎯 配置完成检查清单

- [ ] 云主机 strongSwan 已安装并运行
- [ ] 云主机 VPN 配置文件已创建
- [ ] 云主机防火墙端口已开放
- [ ] 本地 Docker 容器正常运行
- [ ] 本地和云端 PSK 密钥一致
- [ ] 双方 remote_addrs 配置正确
- [ ] 能够发起连接
- [ ] 连接状态显示 ESTABLISHED
- [ ] 双向 ping 测试成功

完成以上所有步骤后，VPN 隧道应该建立成功！🎉
