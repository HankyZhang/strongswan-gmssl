# IKE密钥 vs ESP密钥详解

## 快速回答

**不是！IKE和ESP使用完全不同的密钥。**

```
┌─────────────────────────────────────────────────────────────┐
│                    两套独立的密钥                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  IKE密钥 (IKE SA密钥)                                       │
│  └─ 用途：保护IKE协议消息本身                                │
│  └─ 保护对象：协商消息（握手、认证、重协商等）                │
│  └─ 生命周期：IKE SA的生命周期（通常几小时）                 │
│                                                             │
│  ESP密钥 (Child SA密钥/IPsec密钥)                           │
│  └─ 用途：保护用户的实际数据                                 │
│  └─ 保护对象：IP数据包（应用层数据）                         │
│  └─ 生命周期：Child SA的生命周期（通常较短，支持重密钥）     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 1. 完整的密钥层次结构

### 密钥派生关系图

```
                    Diffie-Hellman密钥交换
                           │
                           │ g^(ab) mod p
                           ↓
                    ┌──────────────┐
                    │   SKEYSEED   │  ← 种子密钥（最原始）
                    └──────────────┘
                           │
                           │ PRF(Ni | Nr, g^ir)
                           ↓
        ┌──────────────────────────────────────────┐
        │          PRF+扩展                         │
        │  (使用SKEYSEED派生所有其他密钥)            │
        └──────────────────────────────────────────┘
                           │
          ┌────────────────┴────────────────┐
          ↓                                 ↓
    ┌─────────────┐                  ┌─────────────┐
    │  IKE SA密钥  │                  │  SK_d       │
    │  (7个密钥)   │                  │  (派生密钥)  │
    └─────────────┘                  └─────────────┘
          │                                 │
          │                                 │ 用于派生ESP密钥
          │                                 ↓
          │                          ┌─────────────┐
          │                          │ Child SA密钥 │
          │                          │ (ESP密钥)    │
          │                          └─────────────┘
          │
          ↓
    用于保护IKE消息
```

### 详细的密钥派生过程

```
阶段1：IKE_SA_INIT - 派生IKE SA密钥
======================================

输入材料：
  - DH共享密钥：g^(ab) mod p
  - 发起方随机数：Ni
  - 响应方随机数：Nr

步骤1：计算SKEYSEED
  SKEYSEED = prf(Ni | Nr, g^ir)
  └─ 使用协商的PRF（如PRF-HMAC-SHA256）
  └─ 密钥：Ni | Nr（两个随机数拼接）
  └─ 数据：DH共享密钥

步骤2：使用PRF+派生IKE密钥材料
  seed = Ni | Nr | SPIi | SPIr
  
  keymat = PRF+(SKEYSEED, seed)
  
  // PRF+是一个扩展函数，可以生成任意长度的密钥材料
  // T1 = PRF(SKEYSEED, seed | 0x01)
  // T2 = PRF(SKEYSEED, T1 | seed | 0x02)
  // T3 = PRF(SKEYSEED, T2 | seed | 0x03)
  // keymat = T1 | T2 | T3 | ...

步骤3：分割密钥材料，得到7个IKE密钥
  从keymat中依次提取：
  
  ┌────────────────────────────────────────────────────┐
  │  IKE SA密钥（7个）                                  │
  ├────────────────────────────────────────────────────┤
  │  1. SK_d  (32字节)  - 用于后续派生Child SA密钥     │
  │  2. SK_ai (32字节)  - IKE完整性密钥（发起方→响应方）│
  │  3. SK_ar (32字节)  - IKE完整性密钥（响应方→发起方）│
  │  4. SK_ei (32字节)  - IKE加密密钥（发起方→响应方）  │
  │  5. SK_er (32字节)  - IKE加密密钥（响应方→发起方）  │
  │  6. SK_pi (32字节)  - AUTH载荷密钥（发起方）        │
  │  7. SK_pr (32字节)  - AUTH载荷密钥（响应方）        │
  └────────────────────────────────────────────────────┘

  // 使用示例：AES-256 + HMAC-SHA256
  keymat长度 = 3×32 + 32 + 32 + 32 + 32 = 224字节


阶段2：CREATE_CHILD_SA - 派生ESP密钥
======================================

输入材料：
  - SK_d：从IKE SA密钥中取出
  - 新的随机数：Ni (新), Nr (新)
  - 可选：新的DH共享密钥（如果使用PFS）

步骤1：使用SK_d派生ESP密钥
  seed = [g^ir (新)] | Ni (新) | Nr (新)
  
  keymat = PRF+(SK_d, seed)
  └─ 注意：这里用SK_d作为密钥，不是SKEYSEED

步骤2：分割密钥材料，得到4个ESP密钥
  
  ┌────────────────────────────────────────────────────┐
  │  Child SA密钥（ESP密钥，4个）                       │
  ├────────────────────────────────────────────────────┤
  │  1. SK_ei (32字节)  - ESP加密密钥（发起方→响应方）  │
  │  2. SK_ai (32字节)  - ESP完整性密钥（发起方→响应方）│
  │  3. SK_er (32字节)  - ESP加密密钥（响应方→发起方）  │
  │  4. SK_ar (32字节)  - ESP完整性密钥（响应方→发起方）│
  └────────────────────────────────────────────────────┘

  // 使用示例：AES-256 + HMAC-SHA256
  keymat长度 = 32 + 32 + 32 + 32 = 128字节
```

---

## 2. IKE密钥的用途

### IKE SA密钥详细说明

```
┌─────────────────────────────────────────────────────────────┐
│  SK_ei / SK_er - IKE加密密钥                                │
├─────────────────────────────────────────────────────────────┤
│  用途：加密IKE协议消息                                       │
│  算法：根据提案（如AES-CBC-256, SM4-CBC）                    │
│  使用场景：                                                  │
│    - IKE_AUTH消息（包含认证信息）                            │
│    - CREATE_CHILD_SA消息                                    │
│    - INFORMATIONAL消息（如删除、重密钥通知）                 │
│                                                             │
│  示例：                                                      │
│    发送IKE_AUTH请求：                                        │
│      plaintext = [IDi, AUTH, SAi2, TSi, TSr, ...]          │
│      ciphertext = AES-256-CBC(SK_ei, plaintext)            │
│      发送：[IKE头, IV, ciphertext, ICV]                     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  SK_ai / SK_ar - IKE完整性密钥                              │
├─────────────────────────────────────────────────────────────┤
│  用途：验证IKE消息的完整性和真实性                           │
│  算法：根据提案（如HMAC-SHA256, HMAC-SM3）                   │
│  使用场景：所有加密的IKE消息                                 │
│                                                             │
│  示例：                                                      │
│    计算ICV（完整性校验值）：                                 │
│      ICV = HMAC-SHA256(SK_ai, IKE头 | IV | 密文)           │
│      接收方验证：                                            │
│        计算ICV' = HMAC-SHA256(SK_ar, 收到的数据)            │
│        if (ICV == ICV'): 消息完整 ✓                         │
│        else: 消息被篡改 ✗                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  SK_pi / SK_pr - AUTH载荷密钥                               │
├─────────────────────────────────────────────────────────────┤
│  用途：计算认证数据（仅在IKE_AUTH阶段使用一次）              │
│  使用场景：生成AUTH载荷                                      │
│                                                             │
│  示例：                                                      │
│    InitiatorSignedOctets = IKE_SA_INIT_msg | Nr |           │
│                            prf(SK_pi, IDi')                 │
│    AUTH = sign(私钥, InitiatorSignedOctets)                 │
│                                                             │
│    发起方用SK_pi，响应方用SK_pr                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  SK_d - 派生密钥                                            │
├─────────────────────────────────────────────────────────────┤
│  用途：派生Child SA（ESP）的密钥                            │
│  特点：永远不直接用于加密或完整性验证                        │
│        只用作PRF+的输入密钥                                  │
│                                                             │
│  使用场景：                                                  │
│    - CREATE_CHILD_SA：创建新的ESP SA                        │
│    - 重密钥：更新ESP密钥                                     │
│                                                             │
│  生命周期：与IKE SA相同（通常几小时到几天）                  │
└─────────────────────────────────────────────────────────────┘
```

### IKE消息保护示例

```
发送IKE_AUTH消息（使用IKE密钥）
=====================================

原始消息：
  ┌──────────────────────────────────┐
  │  IKE_AUTH 请求                   │
  ├──────────────────────────────────┤
  │  HDR (IKE头，明文)               │
  │  SK {                            │  ← 这部分被加密和保护
  │    IDi (身份)                    │
  │    AUTH (认证数据)               │
  │    SAi2 (ESP提案)                │
  │    TSi, TSr (流量选择器)         │
  │    ...                           │
  │  }                               │
  └──────────────────────────────────┘

加密过程：
  1. 生成随机IV（16字节）
  
  2. 拼接载荷
     plaintext = IDi | AUTH | SAi2 | TSi | TSr | ...
  
  3. 添加填充（使长度是块大小的倍数）
     padded = plaintext | padding | pad_len | next_hdr
  
  4. 使用SK_ei加密
     ciphertext = AES-256-CBC(SK_ei, IV, padded)
  
  5. 计算完整性
     to_sign = IKE_HDR | IV | ciphertext
     ICV = HMAC-SHA256(SK_ai, to_sign)
  
  6. 发送
     send(IKE_HDR | IV | ciphertext | ICV)

接收方解密：
  1. 提取ICV，验证完整性
     ICV' = HMAC-SHA256(SK_ar, IKE_HDR | IV | ciphertext)
     if (ICV != ICV'): 丢弃消息 ✗
  
  2. 使用SK_er解密
     padded = AES-256-CBC-decrypt(SK_er, IV, ciphertext)
  
  3. 移除填充
     plaintext = remove_padding(padded)
  
  4. 解析载荷
     parse(IDi, AUTH, SAi2, TSi, TSr, ...)
```

---

## 3. ESP密钥的用途

### Child SA密钥（ESP密钥）详细说明

```
┌─────────────────────────────────────────────────────────────┐
│  SK_ei / SK_er - ESP加密密钥                                │
├─────────────────────────────────────────────────────────────┤
│  用途：加密实际的IP数据包                                    │
│  算法：根据ESP提案（如AES-CBC-256, SM4-CBC）                 │
│  使用场景：所有ESP数据包                                     │
│                                                             │
│  示例：                                                      │
│    发送数据包：                                              │
│      plaintext = IP包 | padding                            │
│      ciphertext = AES-256-CBC(ESP_SK_ei, IV, plaintext)    │
│                                                             │
│  注意：这个SK_ei和IKE的SK_ei是不同的密钥！                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  SK_ai / SK_ar - ESP完整性密钥                              │
├─────────────────────────────────────────────────────────────┤
│  用途：验证IP数据包的完整性                                  │
│  算法：根据ESP提案（如HMAC-SHA256, HMAC-SM3）                │
│  使用场景：所有ESP数据包                                     │
│                                                             │
│  示例：                                                      │
│    ICV = HMAC-SHA256(ESP_SK_ai, ESP_HDR | IV | ciphertext) │
│                                                             │
│  注意：这个SK_ai和IKE的SK_ai是不同的密钥！                   │
└─────────────────────────────────────────────────────────────┘
```

### ESP数据包保护示例

```
发送ESP数据包（使用ESP密钥）
=====================================

原始IP包：
  ┌──────────────────────────────────┐
  │  IP包                            │
  ├──────────────────────────────────┤
  │  IP头: 192.168.1.10 → 10.0.0.5  │
  │  TCP头: port 443                 │
  │  应用数据: HTTPS流量              │
  └──────────────────────────────────┘

ESP封装和加密：
  1. 生成随机IV
  
  2. 添加填充
     plaintext = [IP包] | padding | pad_len | next_hdr
  
  3. 使用ESP加密密钥加密（注意：不是IKE密钥！）
     ciphertext = AES-256-CBC(ESP_SK_ei, IV, plaintext)
                                ^^^^^^^^
                                这是ESP密钥，不是IKE密钥
  
  4. 构造ESP包
     ESP包 = [SPI | Seq | IV | ciphertext]
  
  5. 计算ESP完整性（使用ESP完整性密钥）
     ICV = HMAC-SHA256(ESP_SK_ai, ESP包)
                       ^^^^^^^^
                       这是ESP密钥，不是IKE密钥
  
  6. 最终ESP包
     [SPI(4) | Seq(4) | IV(16) | ciphertext | ICV(16)]
  
  7. 添加新的IP头（隧道模式）
     [外层IP头] | [ESP包]
     发送到网络

接收ESP数据包：
  1. 根据SPI查找ESP SA，获取ESP密钥
  
  2. 验证完整性（使用ESP完整性密钥）
     ICV' = HMAC-SHA256(ESP_SK_ar, ESP包)
     if (ICV != ICV'): 丢弃包 ✗
  
  3. 解密（使用ESP加密密钥）
     plaintext = AES-256-CBC-decrypt(ESP_SK_er, IV, ciphertext)
  
  4. 移除填充，获得原始IP包
  
  5. 传递给IP栈处理
```

---

## 4. 两套密钥的对比

### 关键差异表

| 特性 | IKE密钥 | ESP密钥 |
|------|---------|---------|
| **数量** | 7个密钥 | 4个密钥 |
| **派生源** | SKEYSEED（来自DH密钥交换） | SK_d（来自IKE密钥） |
| **保护对象** | IKE协议消息 | IP数据包 |
| **使用频率** | 较低（仅协商时） | 极高（每个数据包） |
| **生命周期** | 长（几小时到几天） | 较短（可频繁更新） |
| **密钥材料长度** | 224字节（AES256+SHA256示例） | 128字节（AES256+SHA256示例） |
| **性能要求** | 低 | 高（需要硬件加速） |
| **重密钥** | 重新协商IKE SA | CREATE_CHILD_SA |

### 生命周期对比

```
时间线：
════════════════════════════════════════════════════════════════

0min    IKE_SA_INIT
        └─ 派生IKE密钥（7个）
        
1min    IKE_AUTH
        └─ 使用IKE密钥保护认证消息
        
2min    CREATE_CHILD_SA
        └─ 使用SK_d派生ESP密钥（4个）
        
3min    数据传输
        └─ 使用ESP密钥保护IP包
        ├─ IKE密钥：空闲（不使用）
        └─ ESP密钥：高频使用（每个包）

...

60min   ESP重密钥（可选）
        └─ CREATE_CHILD_SA（使用IKE密钥保护此消息）
        └─ 派生新的ESP密钥
        └─ IKE密钥：不变
        
...

240min  IKE重协商
        └─ 新的IKE_SA_INIT
        └─ 派生新的IKE密钥
        └─ 派生新的ESP密钥
```

---

## 5. 为什么要分开？

### 原因1：安全性

```
安全原则：密钥分离
==================

如果使用相同密钥：
  ✗ 控制平面和数据平面共用密钥
  ✗ 数据泄露会影响控制协议
  ✗ 密钥使用次数过多，增加破解风险

分开使用：
  ✓ IKE密钥只用于协商（使用次数少）
  ✓ ESP密钥只用于数据（可以频繁更换）
  ✓ 即使ESP密钥泄露，攻击者也无法伪造控制消息
  ✓ 即使IKE密钥泄露，历史ESP数据依然安全（如果用了PFS）
```

### 原因2：性能

```
性能优化
========

IKE密钥：
  - 使用频率低
  - 可以使用软件实现
  - 可以使用复杂算法（如RSA签名）

ESP密钥：
  - 使用频率极高（每秒数千个包）
  - 通常需要硬件加速（如AES-NI, 国密加速卡）
  - 算法选择更注重性能

如果混用：
  ✗ 无法针对不同场景优化
  ✗ 硬件加速器难以区分密钥用途
```

### 原因3：灵活性

```
灵活的密钥管理
==============

IKE SA：
  - 生命周期：24小时
  - 不需要频繁更新（协商开销大）

Child SA (ESP)：
  - 生命周期：1小时
  - 可以频繁重密钥（通过现有IKE SA）
  - 不需要重新认证

优势：
  ✓ 可以更新ESP密钥，而不重新认证
  ✓ 支持PFS（完美前向保密）
  ✓ 一个IKE SA可以管理多个Child SA
```

---

## 6. 多个Child SA的场景

### 一个IKE SA，多个ESP SA

```
场景：同时访问多个网段
======================

IKE SA（一个）
  ├─ IKE密钥（7个）
  │  └─ 保护所有IKE消息
  │
  └─ SK_d（派生密钥）
      │
      ├─ Child SA 1 (ESP密钥A)
      │  └─ 保护 192.168.1.0/24 ↔ 10.0.0.0/24 流量
      │
      ├─ Child SA 2 (ESP密钥B)
      │  └─ 保护 192.168.1.0/24 ↔ 10.1.0.0/24 流量
      │
      └─ Child SA 3 (ESP密钥C)
         └─ 保护 192.168.2.0/24 ↔ 10.2.0.0/24 流量

每个Child SA有独立的ESP密钥（4个），但共享IKE密钥。
```

---

## 7. 代码中的密钥存储

### IKE SA密钥存储

```c
// src/libcharon/sa/ikev2/keymat_v2.c

typedef struct {
    // IKE SA密钥
    chunk_t skd;       // SK_d - 用于派生Child SA密钥
    chunk_t sk_ai;     // SK_ai - IKE完整性（发起→响应）
    chunk_t sk_ar;     // SK_ar - IKE完整性（响应→发起）
    chunk_t sk_ei;     // SK_ei - IKE加密（发起→响应）
    chunk_t sk_er;     // SK_er - IKE加密（响应→发起）
    chunk_t sk_pi;     // SK_pi - AUTH计算（发起方）
    chunk_t sk_pr;     // SK_pr - AUTH计算（响应方）
    
    // IKE加密器和签名器（使用上述密钥初始化）
    aead_t *aead_i;    // 发起方方向的AEAD
    aead_t *aead_r;    // 响应方方向的AEAD
    
} keymat_v2_t;

// IKE消息加密示例
aead_i->encrypt(aead_i, plaintext, aad, NULL, &ciphertext);
// 内部使用SK_ei加密，SK_ai计算ICV
```

### Child SA（ESP）密钥存储

```c
// src/libcharon/sa/child_sa.c

typedef struct {
    // ESP密钥（与IKE密钥完全独立！）
    chunk_t encr_i;    // ESP加密密钥（发起→响应）
    chunk_t integ_i;   // ESP完整性密钥（发起→响应）
    chunk_t encr_r;    // ESP加密密钥（响应→发起）
    chunk_t integ_r;   // ESP完整性密钥（响应→发起）
    
    // ESP加密器和签名器
    crypter_t *crypter_i;   // 发起方向加密器
    signer_t *signer_i;     // 发起方向签名器
    crypter_t *crypter_r;   // 响应方向加密器
    signer_t *signer_r;     // 响应方向签名器
    
} child_sa_t;

// ESP数据包加密示例
crypter_i->encrypt(crypter_i, plaintext, iv, &ciphertext);
signer_i->get_signature(signer_i, data, icv);
// 内部使用ESP密钥，不是IKE密钥！
```

---

## 8. 总结

### 关键要点

```
┌────────────────────────────────────────────────────────────┐
│  IKE密钥 ≠ ESP密钥                                         │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  IKE密钥：                                                 │
│    ✓ 保护IKE协议本身（控制平面）                           │
│    ✓ 从DH密钥交换派生                                      │
│    ✓ 生命周期长，使用频率低                                │
│    ✓ 包含7个不同用途的密钥                                 │
│                                                            │
│  ESP密钥：                                                 │
│    ✓ 保护IP数据包（数据平面）                              │
│    ✓ 从IKE的SK_d派生                                       │
│    ✓ 生命周期短，使用频率高                                │
│    ✓ 包含4个不同方向的密钥                                 │
│                                                            │
│  关系：                                                    │
│    IKE密钥 → SK_d → ESP密钥                                │
│    （派生关系，但使用场景完全不同）                         │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 实际例子

```
场景：发送一个HTTPS请求
=======================

1. IKE协商阶段（使用IKE密钥）
   - IKE_SA_INIT消息：前两条消息明文
   - IKE_AUTH消息：使用IKE密钥加密
     └─ AES-256-CBC(IKE_SK_ei, 认证数据)
     └─ HMAC-SHA256(IKE_SK_ai, 消息)

2. 数据传输阶段（使用ESP密钥）
   - HTTPS请求（GET / HTTP/1.1）
   - 封装为IP包
   - 使用ESP密钥保护
     └─ AES-256-CBC(ESP_SK_ei, IP包)  ← 不同的密钥！
     └─ HMAC-SHA256(ESP_SK_ai, ESP包) ← 不同的密钥！

3. ESP重密钥（使用两种密钥）
   - CREATE_CHILD_SA消息：使用IKE密钥加密
   - 派生新的ESP密钥：使用IKE的SK_d
   - 后续数据：使用新的ESP密钥
```

**记住：IKE是"管理员"，ESP是"工人"。管理员的钥匙（IKE密钥）和工人的钥匙（ESP密钥）当然要分开！**
