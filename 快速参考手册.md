# strongSwan 国密插件 - 快速参考手册

## 🚀 快速开始

### 1分钟了解项目

**项目**: 为 strongSwan IPsec VPN 添加中国国密算法支持  
**算法**: SM2 (非对称) + SM3 (哈希) + SM4 (对称加密)  
**状态**: 源码100%完成,编译验证中  
**仓库**: https://github.com/HankyZhang/strongswan-gmssl

---

## 📁 关键文件位置

### 源代码
```
src/libstrongswan/plugins/gmsm/
├── gmsm_plugin.c/h          # 插件主体
├── gmsm_sm3_hasher.c/h      # SM3 哈希
├── gmsm_sm4_crypter.c/h     # SM4 加密
├── gmsm_sm2_private_key.c/h # SM2 私钥
├── gmsm_sm2_public_key.c/h  # SM2 公钥
└── Makefile.am              # 构建配置
```

### 核心修改
```
src/libstrongswan/crypto/hashers/hasher.h   # +HASH_SM3
src/libstrongswan/crypto/crypters/crypter.h # +ENCR_SM4_CBC/GCM
src/libstrongswan/credentials/keys/public_key.h # +KEY_SM2
configure.ac  # 插件配置
```

### 配置文件
```
config/swanctl/swanctl-gmssl.conf  # 国密算法VPN配置
```

### 文档
```
国密插件开发指南.md         # 完整开发文档
gmsm插件快速开始.md          # 30分钟快速上手
PROJECT_COMPLETION_REPORT.md # 项目完成报告
VERIFICATION_REPORT.md       # 验证报告
项目总结.md                  # 项目总结
```

---

## ⚡ 编译快速命令

### WSL Ubuntu (推荐)
```bash
# 执行一键编译脚本
wsl -d Ubuntu bash /mnt/c/Code/strongswan/wsl-build-gmsm.sh

# 检查插件
ls -lh src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so
```

### 手动编译
```bash
cd /mnt/c/Code/strongswan

# 1. 安装依赖
sudo apt install -y build-essential autoconf automake \
    libtool pkg-config libssl-dev libgmp-dev cmake

# 2. 安装 GmSSL
cd /tmp
wget https://github.com/guanzhi/GmSSL/archive/refs/tags/v3.1.1.tar.gz
tar -zxf v3.1.1.tar.gz && cd GmSSL-3.1.1
mkdir build && cd build
cmake -DCMAKE_C_FLAGS="-std=gnu99" ..
make && sudo make install && sudo ldconfig

# 3. 编译 strongSwan
cd /mnt/c/Code/strongswan
./autogen.sh
./configure --enable-gmsm --enable-openssl
make -j$(nproc)

# 4. 验证
ls -lh src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so
```

---

## 🔍 验证插件

### 符号表检查
```bash
PLUGIN=src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so

# 导出的符号
nm -D $PLUGIN | grep " T " | grep gmsm

# GmSSL 依赖
nm -u $PLUGIN | grep -E "sm2_|sm3_|sm4_"

# 依赖库
ldd $PLUGIN
```

### 安装插件
```bash
sudo make install

# 检查安装
ls -lh /usr/local/strongswan/lib/ipsec/plugins/libstrongswan-gmsm.so
```

---

## 📝 配置国密VPN

### 1. 编辑配置
```bash
# 使用国密配置
cp config/swanctl/swanctl-gmssl.conf /etc/swanctl/swanctl.conf
```

### 2. 关键配置项
```yaml
connections {
  site-to-cloud-gm {
    # IKE 提案: 国密算法优先
    proposals = sm4cbc-sm3-sm2,sm4cbc128-sm3-modp2048
    
    children {
      cloud-net-gm {
        # ESP 提案: 国密对称加密
        esp_proposals = sm4gcm128-sm3-modp2048,sm4cbc-sm3-modp2048
      }
    }
  }
}
```

### 3. 加载配置
```bash
swanctl --load-all
swanctl --list-sas
```

---

## 🐛 常见问题

### Q1: 编译时提示 "USE_GMSM does not appear in AM_CONDITIONAL"
**A**: 在 `configure.ac` 添加:
```bash
AM_CONDITIONAL(USE_GMSM, test x$gmsm = xtrue)
```

### Q2: GmSSL 编译错误 "fd_set undeclared"
**A**: 使用 `-std=gnu99` 而不是 `-std=c99`:
```bash
cmake -DCMAKE_C_FLAGS="-std=gnu99" ..
```

### Q3: SM2_POINT 类型转换错误
**A**: 使用 GmSSL API:
```c
uint8_t buf[65];
sm2_point_to_uncompressed_octets(&point, buf);
```

### Q4: VPN 连接失败,显示 "no proposal found"
**A**: 检查:
1. gmsm 插件是否编译安装
2. strongswan.conf 是否加载 gmsm
3. 两端配置的算法提案是否一致

---

## 📊 算法对比表

| 类别 | 传统算法 | 国密算法 | 密钥长度 |
|------|---------|---------|---------|
| 对称加密 | AES | SM4 | 128位 |
| 哈希 | SHA-256 | SM3 | 256位输出 |
| 非对称 | RSA/ECDSA | SM2 | 256位椭圆曲线 |
| 密钥交换 | ECDH/MODP | SM2/MODP | - |

---

## 🔗 相关链接

- **strongSwan 官网**: https://www.strongswan.org/
- **GmSSL 项目**: https://github.com/guanzhi/GmSSL
- **国密算法标准**: http://www.gmbz.org.cn/
- **本项目 GitHub**: https://github.com/HankyZhang/strongswan-gmssl

---

## 💡 核心API

### SM3 哈希
```c
SM3_CTX ctx;
sm3_init(&ctx);
sm3_update(&ctx, data, len);
sm3_finish(&ctx, hash);  // 32字节
```

### SM4 加密
```c
SM4_KEY key;
sm4_set_encrypt_key(&key, key_bytes);  // 16字节密钥
sm4_cbc_encrypt(&key, iv, in, inlen, out);
sm4_cbc_decrypt(&key, iv, in, inlen, out);
```

### SM2 签名/验证
```c
SM2_KEY key;
sm2_key_generate(&key);
sm2_sign(&key, dgst, sig, &siglen);
sm2_verify(&key, dgst, sig, siglen);
```

### SM2 加密/解密
```c
sm2_encrypt(&key, plain, plainlen, cipher, &cipherlen);
sm2_decrypt(&key, cipher, cipherlen, plain, &plainlen);
```

---

## 📈 性能说明

### 算法性能 (相对)
- **SM4 vs AES-128**: 相近,略慢 (~10%)
- **SM3 vs SHA-256**: 相近
- **SM2 vs ECDSA P-256**: 相近,签名稍快

### 优化建议
- 使用 SM4-GCM 代替 SM4-CBC (认证加密)
- 启用硬件加速 (如果CPU支持)
- 合理配置密钥更新间隔

---

## ✅ 检查清单

### 编译前
- [ ] Ubuntu 22.04+ 或 WSL
- [ ] autoconf, automake, libtool
- [ ] pkg-config, libssl-dev
- [ ] GmSSL 3.1.1 已安装

### 编译后
- [ ] libstrongswan-gmsm.so 生成
- [ ] 符号表包含 gmsm_plugin_create
- [ ] ldd 显示链接到 libgmssl.so

### 部署前
- [ ] 插件安装到 plugins 目录
- [ ] strongswan.conf 配置加载
- [ ] swanctl.conf 使用国密算法
- [ ] 两端配置一致

### 测试
- [ ] charon --version 识别插件
- [ ] swanctl --list-sas 显示连接
- [ ] 确认使用 SM2/SM3/SM4
- [ ] ping 测试数据传输

---

## 🎯 下一步

1. **完成编译验证** - WSL 编译中
2. **云主机部署** - Docker 或 Ubuntu 22.04
3. **集成测试** - 两端使用国密算法
4. **性能测试** - 基准测试和优化
5. **生产部署** - 监控和维护

---

**更新时间**: 2025-10-30  
**版本**: v1.0.0  
**维护**: GitHub Copilot
