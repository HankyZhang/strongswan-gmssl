# gmsm 插件 WSL 编译进度报告

**生成时间**: 2024-10-30 上午  
**编译环境**: WSL Ubuntu 24.04.3 LTS  
**目标**: 编译 strongSwan + gmsm 插件 (SM2/SM3/SM4)

---

## 当前状态

### ✅ 已完成
1. **依赖安装完成**
   - gcc-13, g++-13, make
   - cmake 3.28.3
   - autoconf, automake, libtool
   - libssl-dev, libgmp-dev, libpam0g-dev
   - libsystemd-dev, libcurl4-openssl-dev
   - pkg-config, build-essential
   - **总计**: 79 个新包 + 21 个升级包

2. **GmSSL 3.1.1 编译安装完成**
   - 编译配置: `-DCMAKE_C_FLAGS="-std=gnu99"`
   - 安装位置: `/usr/local/lib/libgmssl.so.3.1` (1020 KB)
   - 头文件: `/usr/local/include/gmssl/`
   - 工具: `/usr/local/bin/gmssl`
   - **状态**: ✅ 验证通过

3. **源代码准备**
   - gmsm 插件源码: 11 个文件, 933 行 C 代码
   - 所有文件已提交到 Git: commit ded42b277b
   - **状态**: ✅ 源码完整

### ⏳ 进行中
4. **WSL 编译**
   - **当前阶段**: 步骤 2 - 复制源代码到 Linux 文件系统
   - **原因**: 避免 Windows 文件系统权限问题和换行符问题
   - **方法**: 使用 rsync 从 `/mnt/c/Code/strongswan` 复制到 `/tmp/strongswan-build`
   - **进度**: 复制中... (strongSwan 源码约 50+ MB)
   - **预计时间**: 2-5 分钟

### 📋 待执行
5. **后续步骤** (自动执行)
   - 步骤 3: 验证 gmsm 插件源码存在
   - 步骤 4: 检查 GmSSL 库
   - 步骤 5: 运行 `autogen.sh` 生成 configure
   - 步骤 6: 配置编译选项 `--enable-gmsm`
   - 步骤 7: 编译 (make -j)
   - 步骤 8: 验证插件生成
   - 步骤 9: 复制插件到 `build-output/`

---

## 编译脚本详情

### 编译脚本: `wsl-compile-clean.sh`

**特殊处理**:
- ✅ 复制源码到 Linux 文件系统 (`/tmp/strongswan-build`)
- ✅ 避免 Windows CRLF 换行符问题
- ✅ 避免 Windows 文件系统权限限制
- ✅ 使用 GNU99 标准编译 GmSSL

**编译配置**:
```bash
export CFLAGS="-I/usr/local/include -std=gnu99"
export LDFLAGS="-L/usr/local/lib"

./configure \
    --prefix=/usr/local/strongswan \
    --enable-gmsm \          # ← 启用 gmsm 插件
    --enable-openssl \
    --sysconfdir=/etc
```

**预期输出**:
- `src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so`
- 复制到 Windows: `c:\Code\strongswan\build-output\libstrongswan-gmsm.so`

---

## 技术要点

### 为什么要复制到 Linux 文件系统?

**Windows 文件系统问题**:
1. ❌ **权限问题**: `sed: preserving permissions: Operation not permitted`
2. ❌ **换行符**: Windows CRLF (`\r\n`) vs Linux LF (`\n`)
3. ❌ **性能**: WSL 访问 `/mnt/c/` 比本地 Linux 文件系统慢 2-5 倍
4. ❌ **脚本执行**: `cannot execute: required file not found` (shebang 问题)

**解决方案**:
- ✅ 使用 `rsync` 复制到 `/tmp/strongswan-build`
- ✅ 在 Linux 文件系统中编译
- ✅ 编译完成后复制产物回 Windows

### GmSSL C99 编译要求

GmSSL 3.1.1 代码使用了 C99 特性:
- ❌ **错误**: `for (int i=0; ...)` 在 C89/C90 中不支持
- ✅ **解决**: `-DCMAKE_C_FLAGS="-std=gnu99"`

strongSwan 编译时也需要:
- ✅ `export CFLAGS="-std=gnu99"`

---

## 下一步计划

### 编译完成后

1. **验证插件**
   ```bash
   # 检查文件
   ls -lh c:\Code\strongswan\build-output\libstrongswan-gmsm.so
   
   # 检查符号
   wsl nm -D /mnt/c/Code/strongswan/build-output/libstrongswan-gmsm.so | grep gmsm
   
   # 检查依赖
   wsl ldd /mnt/c/Code/strongswan/build-output/libstrongswan-gmsm.so
   ```

2. **部署到云服务器**
   
   **方案 A: 在云服务器上重新编译** (推荐)
   ```bash
   # 云服务器上使用 Ubuntu 22.04 Docker 容器
   ssh root@101.126.148.5
   docker run -it -v /root/strongswan:/build ubuntu:22.04 bash
   # 在容器内执行相同的编译步骤
   ```
   
   **方案 B: 直接复制 WSL 编译的插件** (快速测试)
   ```bash
   scp c:\Code\strongswan\build-output\libstrongswan-gmsm.so \
       root@101.126.148.5:/usr/local/strongswan/lib/ipsec/plugins/
   ```
   - ⚠️ 可能有兼容性问题(WSL Ubuntu 24.04 vs 云服务器 CentOS 7)

3. **切换 VPN 配置**
   ```bash
   # 云服务器
   cp /path/to/swanctl-gmssl.conf /etc/swanctl/swanctl.conf
   swanctl --load-all
   
   # 本地 Docker
   cp config/swanctl/swanctl-gmssl.conf config/swanctl/swanctl.conf
   docker-compose restart
   ```

4. **测试国密算法**
   ```bash
   swanctl --list-sas
   # 预期输出:
   # IKEv2: SM2/SM3/SM4_CBC
   # ESP: SM4_GCM_128/SM3
   ```

---

## 常见问题

### Q: 编译需要多久?
**A**: 
- 依赖安装: 3-5 分钟 ✅ **已完成**
- GmSSL 编译: 2-3 分钟 ✅ **已完成**
- 源码复制: 2-5 分钟 ⏳ **进行中**
- strongSwan 编译: 5-10 分钟 (取决于 CPU 核心数)
- **总计**: 约 15-20 分钟

### Q: 为什么不在云服务器上编译?
**A**: 
- ❌ 云服务器是 CentOS 7, autotools 版本太老 (PKG_CHECK_VAR 宏未定义)
- ❌ 升级 autotools 可能破坏系统
- ✅ WSL Ubuntu 24.04 环境干净, autotools 版本新

### Q: WSL 编译的插件能在云服务器上用吗?
**A**:
- ⚠️ **理论上**: 可能有兼容性问题 (Ubuntu 24.04 glibc vs CentOS 7 glibc)
- ✅ **推荐**: 在云服务器上使用 Ubuntu 22.04 Docker 容器重新编译
- 🔧 **快速测试**: 先试试直接复制, 不行再重新编译

---

## 实时监控

### 查看编译进度
```powershell
# 在另一个终端
wsl tail -f /tmp/strongswan-build/config.log    # configure 日志
wsl tail -f /tmp/strongswan-build/make.log      # make 日志 (如果输出重定向)
```

### 手动检查
```powershell
# 查看当前阶段
wsl ls -lh /tmp/strongswan-build/

# 查看 gmsm 插件源码
wsl ls -lh /tmp/strongswan-build/src/libstrongswan/plugins/gmsm/
```

---

## 编译配置摘要

| 配置项 | 值 |
|-------|-----|
| 工作目录 | `/tmp/strongswan-build` |
| 源代码目录 | `/mnt/c/Code/strongswan` |
| GmSSL 安装路径 | `/usr/local` |
| strongSwan 安装路径 | `/usr/local/strongswan` |
| 插件输出路径 | `build-output/libstrongswan-gmsm.so` |
| 编译标志 | `-std=gnu99 -I/usr/local/include` |
| 链接标志 | `-L/usr/local/lib` |
| configure 选项 | `--enable-gmsm --enable-openssl` |

---

## 编译成功标志

编译完成后,将输出:
```
✅ 编译成功完成!
==========================================

编译产物:
  - 插件: c:\Code\strongswan\build-output\libstrongswan-gmsm.so
  - 大小: ~100-200 KB

下一步:
  1. 将插件部署到云服务器
  2. 切换配置为 swanctl-gmssl.conf
  3. 测试 SM2/SM3/SM4 VPN 连接
```

---

**最后更新**: 编译进行中,等待源码复制完成...
