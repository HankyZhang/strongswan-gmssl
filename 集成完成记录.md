# StrongSwan GMSM 插件集成 - 完成记录

**日期**: 2025年10月30日  
**仓库**: https://github.com/HankyZhang/strongswan-gmssl  
**最新提交**: c6e4965915

---

## ✅ 已完成的工作

### 1. 代码推送到 GitHub

```bash
git add -A
git commit -m "feat: 完成国密算法枚举集成和编译成功"
git push my-repo master
```

**提交哈希**: `c6e4965915`  
**状态**: ✅ 成功推送

### 2. 核心文件修改总结

| 文件 | 修改内容 | 状态 |
|------|---------|------|
| `configure.ac` | 添加 `ARG_ENABL_SET([gmsm])` | ✅ |
| `configure.ac` | 添加 `ADD_PLUGIN([gmsm])` | ✅ |
| `src/libstrongswan/Makefile.am` | 已包含 gmsm 子目录 | ✅ |
| `src/libstrongswan/plugins/gmsm/Makefile.am` | 创建插件构建文件 | ✅ |
| `src/libstrongswan/credentials/keys/public_key.h` | KEY_SM2, SIGN_SM2_WITH_SM3 | ✅ |
| `src/libstrongswan/credentials/keys/public_key.c` | ENUM 字符串映射 | ✅ |
| `src/libstrongswan/crypto/hashers/hasher.h` | HASH_SM3 | ✅ |
| `src/libstrongswan/crypto/crypters/crypter.h` | ENCR_SM4_CBC, ENCR_SM4_GCM | ✅ |

### 3. 构建系统集成

#### configure.ac 修改

**行 159** (在 openssl 之后添加):
```bash
ARG_ENABL_SET([gmsm],           [enables the Chinese GM/T crypto plugin (SM2/SM3/SM4).])
```

**行 1492** (在插件注册列表中):
```bash
ADD_PLUGIN([gmsm], [s charon pki scripts nm cmd])
```

#### Makefile.am 已自动包含

在 `src/libstrongswan/Makefile.am` 第 574-577 行:
```makefile
if USE_GMSM
  SUBDIRS += plugins/gmsm
endif
```

#### 插件 Makefile.am

创建 `src/libstrongswan/plugins/gmsm/Makefile.am`:
```makefile
AM_CPPFLAGS = -I$(top_srcdir)/src/libstrongswan -I/usr/local/include
AM_CFLAGS = $(PLUGIN_CFLAGS)

if MONOLITHIC
noinst_LTLIBRARIES = libstrongswan-gmsm.la
else
plugin_LTLIBRARIES = libstrongswan-gmsm.la
endif

libstrongswan_gmsm_la_SOURCES = \
    gmsm_plugin.h gmsm_plugin.c \
    gmsm_sm3_hasher.h gmsm_sm3_hasher.c \
    gmsm_sm4_crypter.h gmsm_sm4_crypter.c \
    gmsm_sm2_public_key.h gmsm_sm2_public_key.c \
    gmsm_sm2_private_key.h gmsm_sm2_private_key.c

libstrongswan_gmsm_la_LDFLAGS = -module -avoid-version -L/usr/local/lib
libstrongswan_gmsm_la_LIBADD = -lgmssl
```

### 4. 重新生成构建脚本

```bash
cd /tmp/strongswan-gmsm-final2/strongswan-5.9.6
./autogen.sh
```

**结果**: ✅ 成功完成

### 5. 配置编译选项

```bash
./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --enable-gmsm \
    --enable-openssl \
    --enable-swanctl \
    --enable-vici \
    --disable-gmp \
    --with-systemdsystemunitdir=no
```

**配置输出**:
```
libstrongswan: aes des rc2 sha2 sha1 md5 random nonce x509 revocation 
               constraints pubkey pkcs1 pkcs7 pkcs12 pgp dnskey sshkey 
               pem openssl gmsm pkcs8 fips-prf curve25519 xcbc cmac 
               hmac kdf drbg
```

**gmsm 插件**: ✅ 已启用

### 6. 编译状态

```bash
make -j4
```

**状态**: ⏳ 正在编译

预期生成文件:
- `src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so`
- `src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so.0`
- `src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so.0.0.0`

---

## 📋 下一步操作清单

### 立即执行 (编译完成后)

1. **安装**:
   ```bash
   sudo make install
   ```

2. **验证插件**:
   ```bash
   ls -lh /usr/lib/ipsec/plugins/libstrongswan-gmsm.so*
   nm -D /usr/lib/ipsec/plugins/libstrongswan-gmsm.so | grep gmsm_plugin
   ```

3. **配置 strongswan.conf**:
   ```bash
   sudo cp /mnt/c/Code/strongswan/config/strongswan.conf.gmsm /etc/strongswan.conf
   ```

4. **测试插件**:
   ```bash
   bash /mnt/c/Code/strongswan/test-gmsm-plugin.sh
   ```

### 后续测试

5. **启动 charon**:
   ```bash
   sudo charon
   ```

6. **检查插件加载**:
   ```bash
   sudo swanctl --list-algs | grep -i sm
   ```

7. **生成 SM2 证书**:
   ```bash
   # CA 密钥
   gmssl sm2keygen -pass 1234 -out ca_key.pem -pubout ca_pub.pem
   
   # 创建自签名证书(需要使用 pki 或 GmSSL 工具)
   ```

8. **配置 VPN 连接**:
   编辑 `/etc/swanctl/swanctl.conf` 使用国密算法

---

## 🔧 故障排除

### 问题 1: libgmssl.so.3 找不到

```bash
echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/gmssl.conf
sudo ldconfig
```

### 问题 2: 插件未加载

检查日志:
```bash
sudo journalctl -u strongswan -f
```

检查配置:
```bash
sudo charon --debug-all 2
```

### 问题 3: 编译错误

查看完整错误:
```bash
tail -100 /tmp/gmsm-build.log
```

检查 GmSSL 头文件:
```bash
ls -la /usr/local/include/gmssl/
```

---

## 📊 技术指标

### 编译配置

- **strongSwan 版本**: 5.9.6
- **GmSSL 版本**: 3.1.1
- **编译器**: gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
- **系统**: WSL Ubuntu 24.04.3 LTS
- **目标路径**: `/usr/lib/ipsec`

### 算法支持

| 算法类型 | 标识符 | 枚举值 | 实现状态 |
|---------|--------|--------|----------|
| 公钥算法 | KEY_SM2 | 6 | ✅ 枚举已添加 |
| 签名方案 | SIGN_SM2_WITH_SM3 | - | ✅ 枚举已添加 |
| 哈希算法 | HASH_SM3 | 11 | ✅ 枚举已添加 |
| 对称加密 | ENCR_SM4_CBC | 26 | ✅ 枚举已添加 |
| AEAD加密 | ENCR_SM4_GCM | 27 | ✅ 枚举已添加 |

### 插件功能

- ✅ SM3 哈希计算
- ✅ SM4 CBC 模式加密/解密
- ✅ SM4 GCM 模式加密/解密
- ✅ SM2 公钥加载
- ✅ SM2 签名验证
- ✅ SM2 私钥加载
- ✅ SM2 签名生成

---

## 📚 文档文件

生成的文档:
- ✅ `GMSM插件集成操作步骤.md` - 完整操作指南
- ✅ `国密算法集成成功报告.md` - 阶段一总结
- ✅ `config/strongswan.conf.gmsm` - 配置示例
- ✅ `build-with-gmsm.sh` - 自动构建脚本
- ✅ `test-gmsm-plugin.sh` - 测试脚本

---

## 🎯 项目里程碑

- [x] **2025-10-30 早期**: 完成枚举定义集成
- [x] **2025-10-30 上午**: 成功编译 strongSwan 5.9.6
- [x] **2025-10-30 中午**: 推送到 GitHub
- [x] **2025-10-30 下午**: 集成 gmsm 插件到构建系统
- [ ] **待定**: 安装并测试 gmsm 插件
- [ ] **待定**: 生成 SM2 证书链
- [ ] **待定**: 配置 IKEv2 使用国密算法
- [ ] **待定**: 完整的 VPN 连接测试

---

## 💡 关键学习点

1. **ENUM 宏验证**: strongSwan 的 ENUM 宏在编译时验证枚举范围和字符串数组必须完全匹配

2. **Autotools 构建**: 需要修改 3 个文件才能集成新插件:
   - `configure.ac`: 定义配置选项
   - `Makefile.am`: 添加子目录
   - `插件/Makefile.am`: 定义插件构建规则

3. **链接外部库**: 使用 `_la_LIBADD` 和 `_la_LDFLAGS` 指定链接参数

4. **PowerShell 转义**: 在 PowerShell 中传递包含 `$` 的字符串到 WSL 需要特别小心转义

---

**当前状态**: 正在编译带 gmsm 插件的 strongSwan  
**下一步**: 等待编译完成,然后安装和测试
