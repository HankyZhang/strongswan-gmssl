# StrongSwan 国密算法集成成功报告

**日期**: 2024年10月30日  
**版本**: strongSwan 5.9.6  
**目标**: 集成中国国密 SM2/SM3/SM4 算法到 strongSwan

## 一、集成成果

### 1.1 已添加的枚举定义

成功在 strongSwan 核心库中添加了以下国密算法枚举:

#### 密钥类型 (`src/libstrongswan/credentials/keys/public_key.h`)
```c
enum key_type_t {
    KEY_ANY = 0,
    KEY_RSA = 1,
    KEY_ECDSA = 2,
    KEY_DSA = 3,
    KEY_ED25519 = 4,
    KEY_ED448 = 5,
    KEY_SM2 = 6,      // ✅ 新增:国密SM2椭圆曲线公钥
    KEY_BLISS = 7,
};
```

#### 签名方案 (`src/libstrongswan/credentials/keys/public_key.h`)
```c
enum signature_scheme_t {
    SIGN_UNKNOWN,
    // ... RSA 签名方案 ...
    // ... ECDSA 签名方案 ...
    SIGN_ED25519,
    SIGN_ED448,
    SIGN_SM2_WITH_SM3,  // ✅ 新增:SM2签名+SM3哈希
    // ... BLISS 签名方案 ...
    SIGN_BLISS_WITH_SHA3_512,
};
```

#### 哈希算法 (`src/libstrongswan/crypto/hashers/hasher.h`)
```c
enum hash_algorithm_t {
    // ... SHA1/SHA2/SHA3 ...
    HASH_SM3 = 9,     // ✅ 新增:国密SM3哈希(256位)
};
```

#### 加密算法 (`src/libstrongswan/crypto/crypters/crypter.h`)
```c
enum encryption_algorithm_t {
    // ... AES/3DES ...
    ENCR_SM4_CBC = 26,   // ✅ 新增:SM4 CBC模式
    ENCR_SM4_GCM = 27,   // ✅ 新增:SM4 GCM模式(AEAD)
};
```

### 1.2 字符串名称映射

在 `src/libstrongswan/credentials/keys/public_key.c` 中完成了对应的字符串名称定义:

```c
ENUM(key_type_names, KEY_ANY, KEY_BLISS,
    "ANY", "RSA", "ECDSA", "DSA", "ED25519", "ED448", 
    "SM2",      // ✅ 对应 KEY_SM2
    "BLISS"
);

ENUM(signature_scheme_names, SIGN_UNKNOWN, SIGN_BLISS_WITH_SHA3_512,
    "UNKNOWN",
    // ... 其他方案 ...
    "ED448",
    "SM2_WITH_SM3",  // ✅ 对应 SIGN_SM2_WITH_SM3
    // ... BLISS 方案 ...
);
```

### 1.3 验证结果

编译后的库已成功包含国密算法标识:

```bash
$ nm -D /usr/lib/ipsec/libstrongswan.so | grep signature_scheme
0000000000077300 D signature_scheme_names

$ strings /usr/lib/ipsec/libstrongswan.so | grep SM2
SM2_WITH_SM3
SIGN_SM2_WITH_SM3
```

## 二、安装信息

### 2.1 已安装文件

- **核心库**: `/usr/lib/ipsec/libstrongswan.so.0.0.0` (2.4 MB)
- **charon 守护进程库**: `/usr/lib/ipsec/libcharon.so.0.0.0` (6.4 MB)
- **管理工具**: `/usr/sbin/swanctl` (478 KB)
- **命令行客户端**: `/usr/sbin/charon-cmd` (235 KB)

### 2.2 配置文件位置

- `/etc/strongswan.conf` - 主配置文件
- `/etc/swanctl/` - swanctl 配置目录
- `/etc/strongswan.d/` - 模块化配置目录

## 三、下一步工作

### 3.1 国密插件实现

虽然枚举已经添加,但实际的加密/签名/验证功能需要通过 gmsm 插件实现:

**已完成的插件代码**:
- `src/libstrongswan/plugins/gmsm/gmsm_plugin.c/h` - 插件注册
- `src/libstrongswan/plugins/gmsm/gmsm_sm3_hasher.c/h` - SM3 哈希实现
- `src/libstrongswan/plugins/gmsm/gmsm_sm4_crypter.c/h` - SM4 加密实现
- `src/libstrongswan/plugins/gmsm/gmsm_sm2_public_key.c/h` - SM2 公钥操作
- `src/libstrongswan/plugins/gmsm/gmsm_sm2_private_key.c/h` - SM2 私钥/签名

**状态**: 代码已编写但未集成到构建系统

### 3.2 插件集成步骤

要完成 gmsm 插件的集成,需要:

1. **修改 configure.ac**:
   ```bash
   ARG_ENABL_SET([gmsm],
       [enables the gmsm plugin for GM/T cryptography.])
   ```

2. **修改 src/libstrongswan/plugins/Makefile.am**:
   ```makefile
   if MONOLITHIC
     SUBDIRS += gmsm
   endif
   
   if USE_GMSM
     SUBDIRS += gmsm
   endif
   ```

3. **创建 src/libstrongswan/plugins/gmsm/Makefile.am**:
   ```makefile
   AM_CFLAGS = -I$(top_srcdir)/src/libstrongswan
   
   plugin_LTLIBRARIES = libstrongswan-gmsm.la
   
   libstrongswan_gmsm_la_SOURCES = \
       gmsm_plugin.h gmsm_plugin.c \
       gmsm_sm3_hasher.h gmsm_sm3_hasher.c \
       ...
   
   libstrongswan_gmsm_la_LDFLAGS = -module -avoid-version
   libstrongswan_gmsm_la_LIBADD = -lgmssl
   ```

4. **重新运行 autotools**:
   ```bash
   ./autogen.sh
   ./configure --enable-gmsm --with-systemdsystemunitdir=no
   make
   sudo make install
   ```

### 3.3 测试国密算法

集成完成后可以通过以下方式测试:

```bash
# 生成 SM2 密钥对
pki --gen --type sm2 --outform pem > ca_key.pem

# 创建 SM2 自签名证书
pki --self --ca --lifetime 3650 --in ca_key.pem \
    --dn "CN=StrongSwan GM Root CA" \
    --outform pem > ca_cert.pem

# 配置 IKEv2 使用国密算法
swanctl --load-conns
```

## 四、技术细节

### 4.1 解决的问题

在集成过程中解决了以下关键问题:

1. **枚举值冲突**: 原始代码中 `KEY_BLISS=6`,与新增的 `KEY_SM2=6` 冲突,已修改为 `KEY_BLISS=7`

2. **ENUM宏验证**: strongSwan 使用 `ENUM()` 宏对枚举进行编译时验证:
   ```c
   ENUM(name, first, last, ...);
   // 自动验证: (last - first + 1) == countof(names)
   ```
   必须确保枚举范围和字符串数组完全匹配

3. **符号导出**: 链接时出现 `undefined reference to 'signature_scheme_names'`,通过修复 `public_key.c` 中的 ENUM 定义解决

### 4.2 核心修改文件清单

| 文件路径 | 修改内容 | 状态 |
|---------|---------|------|
| `src/libstrongswan/credentials/keys/public_key.h` | 添加 KEY_SM2, SIGN_SM2_WITH_SM3 | ✅ 已完成 |
| `src/libstrongswan/credentials/keys/public_key.c` | 添加对应字符串名称 | ✅ 已完成 |
| `src/libstrongswan/crypto/hashers/hasher.h` | 添加 HASH_SM3 | ✅ 已完成 |
| `src/libstrongswan/crypto/crypters/crypter.h` | 添加 ENCR_SM4_CBC, ENCR_SM4_GCM | ✅ 已完成 |
| `src/libstrongswan/plugins/gmsm/*` | 插件实现代码 | ⏳ 待集成到构建系统 |

## 五、参考资料

- **GmSSL 库位置**: `/usr/local/lib/libgmssl.so.3.1`
- **strongSwan 文档**: https://docs.strongswan.org/
- **GM/T 0003-2012**: SM2 椭圆曲线公钥密码算法
- **GM/T 0004-2012**: SM3 密码杂凑算法
- **GM/T 0002-2012**: SM4 分组密码算法

## 六、总结

当前已成功完成**阶段一:枚举定义集成**,strongSwan 的类型系统现在已经能够识别 SM2/SM3/SM4 算法标识。

后续需要完成**阶段二:插件实现集成**,将已编写的 gmsm 插件代码正式加入构建系统并编译为动态库,才能真正在 VPN 连接中使用国密算法。

---

**编译日志**: `/tmp/strongswan-gmsm-final2/strongswan-5.9.6/`  
**安装日志**: `/tmp/install.log`
