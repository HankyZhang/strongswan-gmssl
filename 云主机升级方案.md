# 云主机系统迁移方案

## 当前状态
- **云主机**: 101.126.148.5
- **当前系统**: CentOS 7
- **目标系统**: Ubuntu 22.04
- **原因**: CentOS 7 autotools 版本过旧,无法编译 gmsm 插件

---

## 🔥 方案1: 云服务商在线重装 (最简单)

### 步骤:

1. **备份重要数据**
   ```bash
   # 在重装前,确保代码已推送到 GitHub
   cd ~/strongswan-gmssl
   git status  # 确认无未提交更改
   
   # 备份 GmSSL(如果有自定义配置)
   tar -czf ~/gmssl-backup.tar.gz /usr/local/lib/libgmssl.* /usr/local/include/gmssl/
   
   # 下载备份到本地
   scp root@101.126.148.5:~/gmssl-backup.tar.gz .
   ```

2. **登录云服务商控制台**
   - 找到 "重装系统" 或 "更换操作系统" 选项
   - 选择 **Ubuntu 22.04 LTS**
   - 记录新的 root 密码
   - 执行重装(约5-10分钟)

3. **重装后恢复环境**
   ```bash
   # SSH 登录新系统
   ssh root@101.126.148.5
   
   # 更新系统
   apt update && apt upgrade -y
   
   # 安装基础工具
   apt install -y git vim wget curl build-essential
   
   # 克隆代码
   git clone https://github.com/HankyZhang/strongswan-gmssl.git
   cd strongswan-gmssl
   
   # 运行自动安装脚本
   chmod +x verify-gmsm-plugin.sh
   ./verify-gmsm-plugin.sh
   ```

---

## 🐳 方案2: 使用 Docker (推荐,无需重装)

**优势**: 不需要重装系统,在 CentOS 7 上运行 Ubuntu 22.04 容器

### 在云主机安装 Docker

```bash
# SSH 登录云主机
ssh root@101.126.148.5

# 安装 Docker (CentOS 7)
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install -y docker-ce docker-ce-cli containerd.io
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
```

### 在容器中编译

```bash
# 上传 Dockerfile
cd ~/strongswan-gmssl

# 构建编译环境
cat > Dockerfile.build <<'EOF'
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    build-essential autoconf automake libtool pkg-config \
    libssl-dev libgmp3-dev libpam0g-dev libsystemd-dev \
    libcurl4-openssl-dev libcap-ng-dev gettext git wget cmake

# 安装 GmSSL
RUN cd /tmp && \
    wget https://github.com/guanzhi/GmSSL/archive/refs/tags/v3.1.1.tar.gz && \
    tar -zxf v3.1.1.tar.gz && \
    cd GmSSL-3.1.1 && \
    mkdir build && cd build && \
    cmake -DCMAKE_C_FLAGS="-std=gnu99" .. && \
    make -j$(nproc) && make install && \
    ldconfig

WORKDIR /workspace
CMD ["/bin/bash"]
EOF

# 构建镜像
docker build -f Dockerfile.build -t strongswan-builder .

# 在容器中编译
docker run --rm -v $PWD:/workspace -w /workspace strongswan-builder bash -c "
    ./autogen.sh
    ./configure --prefix=/usr/local/strongswan --enable-gmsm --enable-openssl
    make -j\$(nproc)
    make install
    
    # 检查插件
    ls -lh src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so
    nm -D src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so | grep gmsm_plugin_create
"
```

---

## 💻 方案3: 本地 WSL Ubuntu 编译 (最快速)

你的 Windows 已有 WSL,可以直接使用!

### 检查 WSL 版本

```powershell
# 在 PowerShell 中
wsl --list --verbose
```

### 安装 Ubuntu 22.04

```powershell
# 如果没有 Ubuntu 22.04
wsl --install -d Ubuntu-22.04

# 启动
wsl -d Ubuntu-22.04
```

### 在 WSL 中编译

```bash
# 在 WSL Ubuntu 中
cd /mnt/c/Code/strongswan

# 安装依赖
sudo apt update
sudo apt install -y build-essential autoconf automake libtool pkg-config \
    libssl-dev libgmp3-dev libpam0g-dev libsystemd-dev \
    libcurl4-openssl-dev libcap-ng-dev gettext wget cmake

# 安装 GmSSL
cd /tmp
wget https://github.com/guanzhi/GmSSL/archive/refs/tags/v3.1.1.tar.gz
tar -zxf v3.1.1.tar.gz
cd GmSSL-3.1.1
mkdir build && cd build
cmake -DCMAKE_C_FLAGS="-std=gnu99" ..
make -j$(nproc)
sudo make install
sudo ldconfig

# 编译 strongSwan
cd /mnt/c/Code/strongswan
./autogen.sh
./configure --prefix=/usr/local/strongswan --enable-gmsm --enable-openssl
make -j$(nproc)

# 检查结果
ls -lh src/libstrongswan/plugins/gmsm/.libs/libstrongswan-gmsm.so
```

---

## 📊 方案对比

| 方案 | 难度 | 时间 | 优点 | 缺点 |
|------|------|------|------|------|
| 云主机重装 | ⭐⭐⭐ | 20分钟 | 系统干净,长期使用 | 需要云服务商支持,数据需备份 |
| Docker | ⭐⭐ | 10分钟 | 无需重装,隔离环境 | 需要学习 Docker |
| WSL | ⭐ | 5分钟 | 最快速,本地验证 | 只能本地使用,不能部署 |

---

## 🎯 推荐方案

### 立即验证: **方案3 (WSL)**
```powershell
wsl -d Ubuntu-22.04
# 然后按上面步骤编译
```

### 长期使用: **方案2 (Docker)**
- 在云主机安装 Docker
- 在容器中编译和运行 strongSwan
- 保持 CentOS 7 系统不变

### 如果必须重装: **方案1**
- 联系云服务商客服
- 确认支持 Ubuntu 22.04
- 备份数据后执行

---

## ⚡ 快速验证脚本

我已经为你准备好了:
- `verify-gmsm.ps1` - Windows Docker 验证
- `verify-gmsm-plugin.sh` - Linux 编译验证
- `Dockerfile.gmsm-build` - Ubuntu 22.04 编译环境

立即执行:
```powershell
# 方案1: WSL (推荐)
wsl -d Ubuntu-22.04 bash /mnt/c/Code/strongswan/verify-gmsm-plugin.sh

# 方案2: 本地 Docker
cd C:\Code\strongswan
docker build -f Dockerfile.gmsm-build -t strongswan-builder .
docker run --rm -v ${PWD}:/workspace strongswan-builder bash verify-gmsm-plugin.sh
```
